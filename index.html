<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Test Timer ğŸŸ¢</title>
<style>
  :root{
    --bg:#000; --text:#fff;
    --accent:#7ee0ff; /* æ°´è‰²ï¼ˆãƒãƒ¼/æ ï¼‰ */
    --pink:#ff77aa;
    --dim:#666;       /* çµŒé(ç°) */
    --panel:#0a0a0a;
    --border:#2a2a2a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, sans-serif}
  button,input,select{font:inherit}

  /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .screen{display:none; height:100dvh; width:100vw; padding: min(4vw,24px);}
  .screen.active{display:flex}
  .center-col{margin:auto; display:flex; flex-direction:column; align-items:center; gap: min(4vh,24px); width:100%}

  /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
  .title-box{
    display:flex; align-items:center; justify-content:center;
    width:25vw; min-width:280px; max-width:80vw;
    height:16.6vh; min-height:96px; max-height:30vh;
    border:none; background:transparent;
  }
  .title{
    font-weight:900; color:#fff; text-align:center; white-space:nowrap;
    font-size: clamp(56px, 16vw, 18vh);
    letter-spacing:.04em;
}
  .menu-buttons{display:flex; flex-direction:column; gap:min(4vh,24px)} /* ãƒœã‚¿ãƒ³é–“ã‚’åºƒã’ã‚‹ */
  .btn{ 
    padding:.2em .8em; /* ç¸¦ã‚’çŸ­ã */
    border-radius:14px; background:#111; color:#000; cursor:pointer;
    border:3px solid #fff; font-weight:800; letter-spacing:.04em;
    transition:transform .06s ease, opacity .2s ease, background .2s ease;
    touch-action:manipulation;
    font-family:"Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Yu Gothic UI","Yu Gothic","Noto Sans JP",sans-serif;
}
  /* ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨åŒã˜ã‚µã‚¤ã‚ºã« */
.menu-buttons .btn{
  font-size: clamp(28px, 7vw, 8vh); /* å°‘ã—å°ã•ã‚ã«èª¿æ•´ */
  padding:.15em .6em; /* ãƒœã‚¿ãƒ³å…¨ä½“ã‚’å°ã•ã */
}
  .btn:active{transform:scale(.98)}
  .btn.start{border-color:var(--accent); background:var(--accent);}
  .btn.settings{border-color:#fff; background:#fff;}
  .btn:disabled{opacity:.5; cursor:not-allowed}

  /* å®Ÿè¡Œç”»é¢ */
  .run-wrap{margin:auto; display:flex; flex-direction:column; align-items:center; width:100%; gap:min(4vh,28px)}
  .run-title{
    margin-top:2vh; /* ã•ã‚‰ã«ä¸Šã¸ */
    margin-bottom:min(10vh, 80px); /* ãƒˆãƒ©ãƒƒã‚¯ã¨ã®é–“éš”ã‚’ã•ã‚‰ã«åºƒã’ã‚‹ */
    font-size: clamp(30px, 6.75vh, 10.5vh);
    font-weight:700; text-align:center; opacity:.95;
    font-family:"Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Hiragino Maru Gothic","Yu Gothic","Noto Sans JP",sans-serif;
    position:relative; z-index:2;
  }
  .timer{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-size: clamp(60px, 28vh, 34vh);
    font-weight:900; font-style:normal; color:#fff; text-align:center;
    letter-spacing:.05em; line-height:1; white-space:nowrap;
    text-shadow: 0 0 12px rgba(255,255,255,.08);
    transform: scaleX(0.6); /* æ¨ªæ–¹å‘ã‚’60%ã«ã—ã¦å…ƒã®è¦‹ãŸç›®ã«æˆ»ã™ */
  }
        .timer span{ display:inline-block; font-family: "Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Hiragino Maru Gothic","Yu Gothic","Noto Sans JP",sans-serif; font-weight:700; }
  .sep{ margin:0; padding:0; } /* é–“éš”ã‚¼ãƒ­ */
    .sep.colon{ display:inline-block; transform:none; } /* ã‚³ãƒ­ãƒ³ã®ç¸®å°ã‚’è§£é™¤ã—ã¦æ¨™æº–å¹…ã« */


  /* æ™‚è¨ˆã‚’å›²ã‚€ãƒˆãƒ©ãƒƒã‚¯ï¼ˆå·¦å³åŠå††ãƒ»ä¸Šä¸‹ç›´ç·šï¼‰ */
  .timer-track{
    position:relative;
    width:min(86vw, 1100px);
    height:min(24vh, 300px);
    padding: clamp(28px, 4vh, 48px) 0; /* ä¸Šä¸‹ã«ä½™ç™½ã‚’è¿½åŠ  */
    display:flex; align-items:center; justify-content:center;
    margin: min(4vh,32px) auto; /* ä¸Šä¸‹ã®é–“éš”ã‚’ã•ã‚‰ã«åºƒã’ã‚‹ */
    z-index:0; /* å¾Œé¢ã«å›ºå®š */
  }
  .track-svg{ position:relative; width:100%; height:auto; aspect-ratio:1000/460; display:block; }
  .track-outline, .track-progress{
    fill:none;
    stroke-width:55px; /* 2.5å€ */
  }
  .track-outline{ stroke-linecap:round; }
  .track-progress{ stroke-linecap:butt; }
  .track-outline{ stroke: var(--dim); opacity:.95; }
  .track-progress{ stroke: var(--accent); filter: drop-shadow(0 0 6px var(--accent)); }
  /* --- å˜ä½“ã‚¿ã‚¤ãƒãƒ¼ï¼šãƒˆãƒ©ãƒƒã‚¯è‰²ã®ã—ãã„å€¤ï¼†çµ‚äº†ç‚¹æ»… --- */
.tp-warn5{ stroke:#a8ff60 !important; filter: drop-shadow(0 0 6px #a8ff60) !important; } /* 5åˆ†åˆ‡ã‚Šï¼šé»„ç·‘ */
.tp-warn3{ stroke:#ffe066 !important; filter: drop-shadow(0 0 6px #ffe066) !important; } /* 3åˆ†åˆ‡ã‚Šï¼šé»„è‰² */
.tp-warn1,
.tp-finished{ stroke:#ff3b3b !important; filter: drop-shadow(0 0 8px #ff3b3b) !important; } /* 1åˆ†åˆ‡ã‚Š/çµ‚äº†ï¼šèµ¤ */
@keyframes tpFlashRed{
  0%{ stroke-opacity:1 }
  50%{ stroke-opacity:.25 }
  100%{ stroke-opacity:1 }
}
.tp-flash{ animation: tpFlashRed .6s linear infinite; } /* çµ‚äº†æ™‚ã®èµ¤ç‚¹æ»… */
  .run-controls{display:flex; gap:min(3vw,24px); margin-top:min(12vh,96px); position:relative; z-index:2}
  .btn.run{
    min-width:4em; 
    background:transparent; 
    color:#000;
    font-size:250%;   /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¯ãã®ã¾ã¾ */
    padding:0.5em 1em;  /* ç¸¦æ¨ªã‚µã‚¤ã‚ºã‚’åŠåˆ†ã« */
    font-family: "Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Hiragino Maru Gothic","Yu Gothic","Noto Sans JP",sans-serif;
    font-weight:700;
  }
  .btn.run.start{border-color:var(--accent)}
  .btn.run.stop{border-color:var(--pink)}
/* å®Ÿè¡Œç”»é¢ãƒœã‚¿ãƒ³ã®å¡—ã‚Šã¤ã¶ã—ã‚’æ è‰²ã¨ä¸€è‡´ã•ã›ã‚‹ */
.btn.run.start{border-color:var(--accent); background:var(--accent);}
.btn.run.stop{border-color:var(--pink);   background:var(--pink);}
  /* è¨­å®šç”»é¢ */
  .settings-wrap{margin:auto; width:min(96vw, 1200px); display:flex; flex-direction:column; gap:min(3vh,28px); font-size:200%}
  .settings-wrap h2{margin:0 0 .4em; font-size: clamp(20px, 4vh, 5vh)}
  .row{display:flex; align-items:center; gap:min(2vw,18px); flex-wrap:wrap}
  .quick-row{ margin-top: .8em; }
  .label{min-width:7em; opacity:.9}
  .spacer{min-width:7em}
  .spacer{min-width:7em}
  .time-inputs input{
    width: 3.8em; padding:.2em .3em; text-align:center;
    background:#111; color:#fff; border:2px solid #444; border-radius:10px;
    font-size:150%;
  }
  /* ãƒ©ãƒ™ãƒ«ï¼ˆæ™‚é–“/åˆ†/ç§’ï¼‰ */
  .time-unit{
    margin: 0 .3em;
    font-size: clamp(20px, 4vh, 5vh); /* h2ã¨åŒã˜ã‚µã‚¤ã‚º */
    font-weight:700; color:#fff;
  }
  .quick{display:flex; gap:.6em; flex-wrap:wrap}
  .quick button{
    background:#fff; color:#000; border:2px solid #fff; border-radius:12px; padding:.4em .7em; font-weight:800;
}
  /* ã‚¯ãƒªã‚¢ã ã‘ãƒ”ãƒ³ã‚¯å¡—ã‚Š */
  #btnClearQuick{ background:var(--pink); border-color:var(--pink); color:#000; }
  .text-input{
    flex:1; min-width:8em; padding:.35em .6em; background:#111; color:#fff; border:2px solid #444; border-radius:10px;
}
  .checks{display:flex; align-items:center; gap:1em; flex-wrap:wrap}
  .checks label{display:flex; align-items:center; gap:.4em}
/* è¿½åŠ ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’3å€ã«æ‹¡å¤§ */
.checks input[type="checkbox"]{
  transform: scale(3);
  transform-origin: left center;
  margin-right:.4em;
}
  .foot-actions{display:flex; gap:1em; margin-top:1vh; flex-wrap:wrap}
  .btn.nav{background:#888; color:#000; border-color:#888}
/* è¿½åŠ ï¼šå€‹åˆ¥ã‚«ãƒ©ãƒ¼æŒ‡å®š */
#saveSettings{ background:#fff3b0; border-color:#fff3b0; color:#000; }
#navToRun2{  background:var(--accent); border-color:var(--accent); color:#000; }
  .msg{color:#ffd966; font-size:clamp(14px,2.2vh,18px)}

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ï¼ˆè»½é‡ï¼‰ */
  .topnav{
    position:fixed; top:0; left:0; right:0; height:48px; display:flex; align-items:center; justify-content:space-between;
    padding:0 12px; background:linear-gradient(#000, #060606); border-bottom:1px solid #111;
  }
  .topnav .small{font-weight:700; opacity:.8}
  .topnav .navbtn{
    background:#333; color:#ccc; border:1px solid #333; border-radius:10px; padding:.3em .7em; font-weight:700;
}

/* --- è¤‡æ•°äººã‚¿ã‚¤ãƒãƒ¼ç”¨ --- */
.multi-wrap{
  position:relative; width:100%; height:100%; background:var(--bg);
}
.multi-grid{
  position:absolute; inset:0; padding: min(3vw,24px) min(3vw,24px) 92px;
  display:grid; gap:min(2vw,18px);
  align-content:center; justify-items:center;
}
.multi-grid.layout-1{ grid-template-columns: 1fr; }
.multi-grid.layout-2-3{ grid-template-columns: repeat(3, minmax(220px, 1fr)); }
.multi-grid.layout-4{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
.multi-grid.layout-5-6{ grid-template-columns: repeat(3, minmax(220px, 1fr)); }
.multi-grid.layout-7-8{ grid-template-columns: repeat(4, minmax(180px, 1fr)); }
.multi-grid.layout-9-12{ grid-template-columns: repeat(4, minmax(200px, 1fr)); }

/* ã‚«ãƒ¼ãƒ‰ï¼ˆæ­£æ–¹å½¢ãƒ»ä¸¸è§’ï¼‰ */
.multi-card{
  width:100%; max-width: 480px; aspect-ratio: 5 / 3; /* æ¨ªé•·é•·æ–¹å½¢ */
  background:#0a0a0a; border:3px solid var(--border); border-radius:24px;
  display:flex; flex-direction:column; justify-content:space-between; align-items:stretch;
  padding:min(2vw,14px);
  box-shadow: 0 6px 20px rgba(0,0,0,.35);
}
.multi-card .mc-title{
  font-weight:800; font-size: clamp(17px, 2.86vh, 26px);
  font-family:"Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Hiragino Sans Rounded W6","Noto Sans JP",sans-serif;
  color:#fff; text-align:center; margin:2px 0 2px; /* é–“éš”ã‚’ç‹­ã */
}
.multi-card .mc-time{
  flex:1; display:flex; align-items:center; justify-content:center;
  font-size: clamp(20px, 6.2vh, 38px);
  transform: scaleX(1.3); letter-spacing:.05em;
  text-shadow: 0 0 10px rgba(255,255,255,.06);
  font-family:"Hiragino Maru Gothic ProN","Hiragino Maru Gothic Pro","Hiragino Maru Gothic","Yu Gothic","Noto Sans JP",sans-serif;
  margin: 2px 0; /* é–“éš”ã‚’ç‹­ã */
}
.multi-card .mc-time .sep.colon{ display:inline-block; transform:none; }
.multi-card .mc-bar{
  height:12px; background:var(--dim); border-radius:999px; overflow:hidden;
  box-shadow: inset 0 0 0 2px #222; margin:4px 0 6px; /* é–“éš”ã‚’ç‹­ã */
}
.multi-card .mc-bar .mc-bar-fill{
  height:100%; width:100%;
  background: linear-gradient(90deg, #aaf0ff, var(--accent)); /* é€šå¸¸è‰² */
  transition: width .2s linear;
}
/* ã—ãã„å€¤ã«å¿œã˜ãŸã‚²ãƒ¼ã‚¸è‰²ï¼ˆã‚«ãƒ¼ãƒ‰å´ã®ã‚¯ãƒ©ã‚¹ã«è¿½å¾“ï¼‰ */
.mt-warn5 .mc-bar-fill{ background: linear-gradient(90deg, #d6ff6b, #a8ff60); } /* é»„ç·‘ï¼ˆ5åˆ†åˆ‡ã‚Šï¼‰ */
.mt-warn3 .mc-bar-fill{ background: linear-gradient(90deg, #ffe066, #ffd24d); } /* é»„è‰²ï¼ˆ3åˆ†åˆ‡ã‚Šï¼‰ */
.mt-warn1 .mc-bar-fill,
.mt-finished .mc-bar-fill{ background: linear-gradient(90deg, #ff6b6b, #ff3b3b); } /* èµ¤ï¼ˆ1åˆ†åˆ‡ã‚Š/çµ‚äº†ï¼‰ */
.multi-card .mc-status{
  display:flex; align-items:center; justify-content:center;
  gap:10px; /* 2ãƒœã‚¿ãƒ³ã®é–“éš” */
}
.multi-card .mc-status .btn{
  background:var(--accent); border-color:var(--accent); color:#000;
  padding:.32em .7em; border-radius:12px; border:3px solid var(--accent);
  font-weight:800; font-size: clamp(14px, 2.2vh, 18px);
}

/* è¿½åŠ ãƒœã‚¿ãƒ³ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼æˆ»ã‚‹ï¼ˆå³ä¸‹å›ºå®šã®æ¨ªä¸¦ã³ï¼‰ */
.multi-actions{
  position:absolute; right:20px; bottom:20px;
  display:flex; flex-direction:row; align-items:center; gap:16px;
}
.add-fab{
  width:56px; height:56px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  padding:0; font-size:28px; line-height:1;
  border:3px solid var(--accent);
  background:var(--accent); color:#000; font-weight:800;
}
.add-fab.hidden{ display:none; }
.back-btn{
  background:#fff; color:#000; border:3px solid #fff;
  border-radius:12px; padding:.6em 1.2em; font-weight:800;
}
/* iPadç”¨ã®éš ã—timeå…¥åŠ› */
.hidden-time-input{
  position:fixed; left:-9999px; top:-9999px; width:0; height:0;
  opacity:0; pointer-events:none;
}



  @media (max-width:600px){
    .title-box{min-width:220px}
    .timer{width: 80vw; height: 40vh}
  }
/* --- ã—ãã„å€¤ç”¨ã®æ è‰²ï¼†çµ‚äº†ç‚¹æ»… --- */
.mt-warn5{ border-color:#a8ff60 !important; } /* é»„ç·‘ */
.mt-warn3{ border-color:#ffe066 !important; } /* é»„è‰² */
.mt-warn1{ border-color:#ff5a5a !important; } /* èµ¤ */
.mt-finished{ border-color:#ff3b3b !important; }
@keyframes mtFlashRed{
  0%{ box-shadow:0 0 0 0 rgba(255,59,59,.9) }
  50%{ box-shadow:0 0 24px 6px rgba(255,59,59,.9) }
  100%{ box-shadow:0 0 0 0 rgba(255,59,59,.9) }
}
.mt-flash{
  animation: mtFlashRed .5s linear infinite;
}
</style>
</head>
<body>

<!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<section id="menu" class="screen active">
  <div class="center-col" style="margin-top:12vh">
    <div class="title-box">
      <div class="title">Test Timer</div>
    </div>
    <div class="menu-buttons">
      <button class="btn start" id="goStart">T-Tä½¿ç”¨ã™ã‚‹</button>
      <button class="btn settings" id="goMulti">è¤‡æ•°äººã§ä½¿ç”¨ã™ã‚‹</button>
    </div>
    <div class="msg" id="menuMsg" aria-live="polite"></div>
  </div>
</section>

<!-- å®Ÿè¡Œç”»é¢ -->
<section id="run" class="screen" aria-live="polite" aria-atomic="true">
  <div class="topnav">
    <div class="small">Test Timer</div>
    <div>
      <button class="navbtn" id="navToMenu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
      <button class="navbtn" id="navToSettings">è¨­å®š</button>
    </div>
  </div>
  <div class="run-wrap">
    <div class="run-title" id="runTitle">title</div>
    <div class="timer-track">
      <svg class="track-svg" viewBox="0 0 1000 460" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <!-- å¤–å‘¨ï¼ˆå·¦å³ã¯æ­£å††ã®åŠåˆ†ã€ä¸Šä¸‹ã¯ç›´ç·šï¼‰ -->
        <path d="M 500,30 H 750 A 200,200 0 0 1 750,430 H 250 A 200,200 0 0 1 250,30 H 500 Z" class="track-outline"/>
        <!-- é€²æ—ï¼ˆå¤–å‘¨ã«æ²¿ã£ã¦æ¸›ã£ã¦ã„ãï¼‰ -->
        <path d="M 500,30 H 750 A 200,200 0 0 1 750,430 H 250 A 200,200 0 0 1 250,30 H 500 Z" class="track-progress" id="barPath"/>
      </svg>

      <div class="timer" id="timeText">
        <span id="hPart">00</span><span class="sep colon">:</span>
        <span id="mPart">00</span><span class="sep colon">:</span>
        <span id="sPart">00</span>
      </div>
    </div>
    <div class="run-controls">
      <button class="btn run start" id="btnToggle">â–¶ï¸</button>
    </div>
    <div class="msg" id="runMsg" style="display:none"></div>
  </div>
</section>

<!-- è¤‡æ•°äººã§ä½¿ç”¨ã™ã‚‹ç”»é¢ -->
<section id="multi" class="screen" aria-live="polite">
  <div class="multi-wrap">
    <div id="multiGrid" class="multi-grid layout-1" data-count="0"></div>

    <!-- å³ä¸‹ã®è¿½åŠ ãƒœã‚¿ãƒ³ï¼‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼æˆ»ã‚‹ -->
    <div class="multi-actions">
      <button id="addTimerBtn" class="add-fab">ï¼‹</button>
      <button id="backToMenuBtn" class="back-btn">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
  </div>
<!-- éš ã—timeå…¥åŠ›ï¼ˆiPadã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ”ãƒƒã‚«ãƒ¼ã‚’å‘¼ã³å‡ºã™ãŸã‚ï¼‰ -->
<input id="hiddenTimePicker" type="time" step="1" class="hidden-time-input" aria-hidden="true">
</section>

<!-- è¨­å®šç”»é¢ -->
<section id="settings" class="screen">
  <div class="topnav">
    <div class="small">è¨­å®š</div>
    <div>
      <button class="navbtn" id="navBackMenu1">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
      <button class="navbtn" id="navToRun">å®Ÿè¡Œã¸</button>
    </div>
  </div>
  <div class="settings-wrap" style="margin-top:56px">
    <!-- æ™‚é–“è¨­å®š -->
    <div>
      <h2>æ™‚é–“è¨­å®š</h2>

      <!-- 1è¡Œç›®ï¼šãƒ©ãƒ™ãƒ«ï¼‹æ™‚é–“å…¥åŠ› -->
      <div class="row">
        <div class="label">æ™‚é–“è¨­å®š</div>
        <div class="time-inputs">
          <input type="number" id="h" min="0" max="24" value="0" aria-label="æ™‚é–“"><span class="time-unit">æ™‚é–“</span>
          <input type="number" id="m" min="0" max="59" value="10" aria-label="åˆ†"><span class="time-unit">åˆ†</span>
          <input type="number" id="s" min="0" max="59" value="0" aria-label="ç§’"><span class="time-unit">ç§’</span>
        </div>
      </div>

      <!-- 2è¡Œç›®ï¼šå·¦ç«¯ã‚’æ™‚é–“å…¥åŠ›ã¨æƒãˆãŸã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³åˆ— -->
      <div class="row quick-row">
        <div class="label spacer"></div>
        <div class="quick" role="group" aria-label="ã‚¯ã‚¤ãƒƒã‚¯åŠ ç®—">
          <button type="button" data-add="600">10åˆ†</button>
          <button type="button" data-add="300">5åˆ†</button>
          <button type="button" data-add="60">1åˆ†</button>
          <button type="button" data-add="30">30ç§’</button>
          <button type="button" data-add="10">10ç§’</button>
          <button type="button" id="btnClearQuick">ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆå -->
    <div class="row">
      <div class="label">ãƒ†ã‚¹ãƒˆå</div>
      <input id="testName" class="text-input" placeholder="ä¾‹ï¼‰è‹±èª ä¸­3 Unit 4 å°ãƒ†ã‚¹ãƒˆ">
    </div>

    <!-- ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ -->
    <div>
            <div class="row checks">
        <div class="label">ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</div>
        <label><input type="checkbox" class="ann" value="-1">é–‹å§‹æ™‚</label>
        <label><input type="checkbox" class="ann" value="300">5åˆ†å‰</label>
        <label><input type="checkbox" class="ann" value="180">3åˆ†å‰</label>
        <label><input type="checkbox" class="ann" value="60">1åˆ†å‰</label>
        <label><input type="checkbox" class="ann" value="0">çµ‚äº†æ™‚</label>
        <span class="flex-break"></span>
        <div class="label spacer"></div>
        <label><input type="checkbox" id="voiceMale">ç”·æ€§</label>
        <label><input type="checkbox" id="voiceFemale" checked>å¥³æ€§</label>
      </div>
      <div class="msg">ï¼ˆéŸ³å£°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®èª­ã¿ä¸Šã’æ©Ÿèƒ½ã‚’ä½¿ç”¨ã€‚å¯¾å¿œç«¯æœ«ã®ã¿ï¼‰</div>
    </div>

        <div class="foot-actions">
      <div class="label spacer"></div>
      <button class="btn nav" id="navToRun2">å®Ÿè¡Œã¸</button>
    </div>
    <div class="msg" id="settingsMsg"></div>
  </div>
</section>

<script>
(function(){
  // ------- çŠ¶æ…‹ -------
  const state = {
    durationSec: 0,         // åˆæœŸè¨­å®šã•ã‚ŒãŸç·ç§’æ•°
    remainSec: 0,           // æ®‹ã‚Šç§’æ•°
    running: false,
    lastTick: 0,
    rafId: null,
    annPoints: new Set(),   // é€šçŸ¥ç§’ãƒã‚¤ãƒ³ãƒˆ
    voice: 'female',        // 'male' | 'female'
    saved: false,
  };

  // ------- è¦ç´  -------
  const $ = sel => document.querySelector(sel);
    const menu = $('#menu'), run = $('#run'), settings = $('#settings'), multi = $('#multi');
  const menuMsg = $('#menuMsg'), runMsg = $('#runMsg'), settingsMsg = $('#settingsMsg');
  const multiGrid = document.getElementById('multiGrid');
  const addTimerBtn = document.getElementById('addTimerBtn');
const hiddenTimePicker = document.getElementById('hiddenTimePicker');

  const goStart = $('#goStart'), goMulti = $('#goMulti');
  const navToMenu = $('#navToMenu'), navToSettings = $('#navToSettings');
  const navBackMenu1 = $('#navBackMenu1'), navToRun = $('#navToRun'), navToRun2 = $('#navToRun2');

  const timeText = $('#timeText'), barPath = $('#barPath'), runTitle = $('#runTitle');

  // ãƒ†ã‚­ã‚¹ãƒˆæ™‚è¨ˆã®å‚ç…§
  const hPart = document.getElementById('hPart');
  const mPart = document.getElementById('mPart');
  const sPart = document.getElementById('sPart');
  const btnToggle = $('#btnToggle');

  const hI = $('#h'), mI = $('#m'), sI = $('#s');
  const quickBtns = document.querySelectorAll('.quick button');
  const testNameI = $('#testName');
  const annChecks = document.querySelectorAll('.ann');
  const voiceMale = $('#voiceMale'), voiceFemale = $('#voiceFemale');
  // const saveSettings = $('#saveSettings'); // ä¿å­˜ãƒœã‚¿ãƒ³å»ƒæ­¢

  // ------- ç”»é¢åˆ‡æ›¿ -------
  function show(id){
    [menu, run, settings, document.getElementById('multi')].forEach(sc => sc && sc.classList.remove('active'));
    id.classList.add('active');
  }

  function requireSettingsOrWarn(nextScreen){
    if (!state.saved || state.durationSec <= 0){
      const msg = 'ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„';
      if (nextScreen === 'run'){
        alert(msg);
      } else {
        menuMsg.textContent = msg;
        setTimeout(()=> menuMsg.textContent = '', 2500);
      }
      return false;
    }
    return true;
  }

  goMulti.addEventListener('click', ()=> {
    show(multi);
  });
  goStart.addEventListener('click', ()=>{
    applySettingsToRun();
    show(run);
  });
  navToSettings.addEventListener('click', ()=> show(settings));
  navBackMenu1.addEventListener('click', ()=> show(menu));
  navToMenu.addEventListener('click', ()=> show(menu));
  navToRun.addEventListener('click', ()=>{
    applySettingsToRun();
    show(run);
  });
  navToRun2.addEventListener('click', ()=>{
    applySettingsToRun();
    show(run);
  });

  // ------- è¨­å®šã®ä¿å­˜ -------
  function getTotalSeconds(){
    const h = Math.max(0, parseInt(hI.value||'0',10));
    const m = Math.max(0, parseInt(mI.value||'0',10));
    const s = Math.max(0, parseInt(sI.value||'0',10));
    return (h*3600 + m*60 + s) | 0;
  }
  function setFromTotal(sec){
    sec = Math.max(0, sec|0);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    hI.value = h; mI.value = m; sI.value = s;
  }
  quickBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      const add = parseInt(b.dataset.add,10) || 0;
      const total = getTotalSeconds() + add;
      setFromTotal(total);
      persistSettings();
    });
  });
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼ˆåˆè¨ˆã‚’0ã«æˆ»ã™ï¼‰
  const btnClearQuick = document.getElementById('btnClearQuick');
  if (btnClearQuick){
    btnClearQuick.addEventListener('click', ()=>{
      setFromTotal(0);
    });
  }

  voiceMale.addEventListener('change', ()=>{
    if (voiceMale.checked){ voiceFemale.checked = false; state.voice = 'male'; }
    else if (!voiceFemale.checked){ voiceFemale.checked = true; state.voice = 'female'; }
  });
  voiceFemale.addEventListener('change', ()=>{
    if (voiceFemale.checked){ voiceMale.checked = false; state.voice = 'female'; }
    else if (!voiceMale.checked){ voiceMale.checked = true; state.voice = 'male'; }
  });

  // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ï¼šå…¥åŠ›ã®ãŸã³ã«ä¿å­˜ï¼†çŠ¶æ…‹æ›´æ–°
  function persistSettings(){
    const total = getTotalSeconds();
    state.durationSec = total;
    // æ®‹ã‚Šæ™‚é–“ã¯ç·æ™‚é–“ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ç¶­æŒï¼ˆæœªé–‹å§‹ãªã‚‰ç·æ™‚é–“ã«ï¼‰
    if (!state.running){
      if (!state.remainSec || state.remainSec > total) state.remainSec = total;
    }
    state.saved = total > 0;

    // ã‚¢ãƒŠã‚¦ãƒ³ã‚¹è¨­å®šã‚’ä¿å­˜
    const points = new Set();
    annChecks.forEach(chk => { if (chk.checked) points.add(parseInt(chk.value,10)); });
    state.annPoints = points;

    // éŸ³å£°ç¨®åˆ¥
    state.voice = voiceMale.checked ? 'male' : 'female';

    // ä¿å­˜
    localStorage.setItem('testTimer.settings', JSON.stringify({
      total, testName: (testNameI.value||'').trim(),
      ann: Array.from(points), voice: state.voice
    }));

    // è»½ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    settingsMsg.textContent = total>0 ? 'è¨­å®šã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸã€‚' : 'åˆè¨ˆæ™‚é–“ãŒ0ç§’ã§ã™ã€‚æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
    setTimeout(()=> settingsMsg.textContent = '', 1200);
  }

  // å…¥åŠ›å¤‰æ›´ã§è‡ªå‹•ä¿å­˜ã‚’ç™ºç«
  [hI, mI, sI, testNameI].forEach(el => {
    el.addEventListener('input', persistSettings);
    el.addEventListener('change', persistSettings);
  });
  annChecks.forEach(chk => chk.addEventListener('change', persistSettings));
  voiceMale.addEventListener('change', persistSettings);
  voiceFemale.addEventListener('change', persistSettings);

  // èµ·å‹•æ™‚ã«å‰å›è¨­å®šã‚’å¾©å…ƒï¼ˆä»»æ„ï¼‰
  try{
    const raw = localStorage.getItem('testTimer.settings');
    if (raw){
      const obj = JSON.parse(raw);
      if (obj && typeof obj.total === 'number'){
        setFromTotal(obj.total);
        testNameI.value = obj.testName || '';
        // ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
        annChecks.forEach(chk => chk.checked = obj.ann ? obj.ann.includes(parseInt(chk.value,10)) : false);
        // éŸ³å£°
        if (obj.voice === 'male'){ voiceMale.checked = true; voiceFemale.checked = false; }
        else { voiceMale.checked = false; voiceFemale.checked = true; }
        // å†…éƒ¨çŠ¶æ…‹åæ˜ ï¼ˆä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ã—ã¦ãªãã¦ã‚‚æ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
        state.durationSec = obj.total;
        state.remainSec = obj.total;
        state.saved = true;
        state.annPoints = new Set(obj.ann || []);
        state.voice = obj.voice || 'female';
      }
    }
  }catch{}

  // ------- å®Ÿè¡Œç”»é¢ã«åæ˜  -------
  function applySettingsToRun(){
    const title = (testNameI.value||'').trim() || 'ãƒ†ã‚¹ãƒˆå';
    runTitle.textContent = title;
    state.remainSec = state.durationSec;
    updateTimeText(state.remainSec);
    updateBar();
    runMsg.textContent = '';
    cancelAnim();
    state.running = false;
    if (btnToggle) btnToggle.textContent = 'â–¶ï¸';
  }

  // ------- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -------

  function updateTimeText(rem){
    const h = Math.floor(rem/3600);
    const m = Math.floor((rem%3600)/60);
    const s = Math.floor(rem%60);
    hPart.textContent = String(h).padStart(2,'0');
    mPart.textContent = String(m).padStart(2,'0');
    sPart.textContent = String(s).padStart(2,'0');
  }

  function updateBar(){
  const total = Math.max(1, state.durationSec);
  const remain = Math.max(0, state.remainSec);
  const ratio = remain / total;

  if (!barPath) return;
  // ä¸€åº¦ã ã‘é•·ã•ã‚’åˆæœŸåŒ–
  if (!barPath._len){
    try{
      barPath._len = barPath.getTotalLength();
      barPath.style.strokeDasharray = barPath._len + ' ' + barPath._len;
    }catch(e){
      // getTotalLengthæœªå¯¾å¿œå¯¾ç­–
      barPath._len = 1000;
      barPath.style.strokeDasharray = '1000 1000';
    }
  }
  // æ®‹ã‚Šæ¯”ç‡ã«å¿œã˜ã¦å¤–å‘¨ã®ãƒ€ãƒƒã‚·ãƒ¥ã‚’æ¸›ã‚‰ã™ï¼ˆ=æ®‹ã‚Šã‚’è¡¨ç¤ºï¼‰
  barPath.style.strokeDashoffset = -barPath._len * (1 - ratio);

  // å˜ä½“ã‚¿ã‚¤ãƒãƒ¼ã®ã—ãã„å€¤è‰²ãƒ»ç‚¹æ»…ã‚’æ›´æ–°
  updateRunTrackVisuals();
}
// å˜ä½“ã‚¿ã‚¤ãƒãƒ¼ï¼šæ®‹ã‚Šæ™‚é–“ã—ãã„å€¤ã§ãƒˆãƒ©ãƒƒã‚¯è‰²ã‚’åˆ‡æ›¿ãƒ»çµ‚äº†æ™‚ã¯ç‚¹æ»…
function updateRunTrackVisuals(forceFinish=false){
  if (!barPath) return;
  barPath.classList.remove('tp-warn5','tp-warn3','tp-warn1','tp-finished','tp-flash');
  const sec = Math.ceil(state.remainSec || 0);
  if (forceFinish || sec <= 0){
    barPath.classList.add('tp-finished','tp-flash'); // èµ¤ã§ç‚¹æ»…
    return;
  }
  if (sec <= 60){
    barPath.classList.add('tp-warn1');  // èµ¤
  }else if (sec <= 180){
    barPath.classList.add('tp-warn3');  // é»„
  }else if (sec <= 300){
    barPath.classList.add('tp-warn5');  // é»„ç·‘
  }
}

  // ------- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -------
  function tick(now){
    if (!state.running) return;
    if (!state.lastTick) state.lastTick = now;
    const dt = (now - state.lastTick)/1000;
    state.lastTick = now;

    const before = state.remainSec;
    state.remainSec = Math.max(0, state.remainSec - dt);

    // ã‚¢ãƒŠã‚¦ãƒ³ã‚¹åˆ¤å®šï¼ˆæ•´æ•°å¢ƒç•Œã§åˆ¤å®šï¼‰
    const beforeInt = Math.ceil(before);
    const afterInt  = Math.ceil(state.remainSec);
    // ä¾‹ï¼šbefore 301 -> after 299 ã®ã¨ã 300 ã‚’è·¨ã
    for (const p of state.annPoints){
      if (beforeInt >= p && afterInt < p){
        speakPoint(p);
      }
    }

    updateTimeText(Math.ceil(state.remainSec));
    updateBar();

    if (state.remainSec <= 0){
  state.running = false;
  cancelAnim();
  // çµ‚äº†æ™‚ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ãŒæœªç™ºç«ãªã‚‰ä¿é™º
  if (state.annPoints.has(0)) speakPoint(0);
  // è¤‡æ•°äººã‚¿ã‚¤ãƒãƒ¼ã¨åŒã˜çµ‚äº†éŸ³
  playAlarm('seiko');
  // ãƒˆãƒ©ãƒƒã‚¯ã‚’èµ¤ã§ç‚¹æ»…
  updateRunTrackVisuals(true);
  // èƒŒæ™¯ã‚‚èµ¤â†”é»’ã§ç‚¹æ»…
  flashEnd();
  if (btnToggle) btnToggle.textContent = 'â–¶ï¸';
  runMsg.textContent = 'ã‚¿ã‚¤ãƒãƒ¼ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚';
  return;
}
    state.rafId = requestAnimationFrame(tick);
  }
  function start(){
    if (!state.saved || state.durationSec<=0){
      alert('ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„');
      return;
    }
    if (state.remainSec<=0) state.remainSec = state.durationSec;
    if (state.running) return;
    state.running = true;
    state.lastTick = 0;
    if (btnToggle) btnToggle.textContent = 'â¸';
    runMsg.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­â€¦';
    cancelAnim();
    if (state.annPoints.has(-1)) speakPoint(-1); // é–‹å§‹æ™‚ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
    state.rafId = requestAnimationFrame(tick);
  }
  function pause(){
    state.running = false;
    cancelAnim();
    if (btnToggle) btnToggle.textContent = 'â–¶ï¸';
    runMsg.textContent = 'ä¸€æ™‚åœæ­¢ä¸­';
  }
  function resetToStart(){
    state.running = false;
    cancelAnim();
    state.remainSec = state.durationSec;
    updateTimeText(state.remainSec);
    updateBar();
    runMsg.textContent = 'é–‹å§‹å‰ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ';
  }
  function cancelAnim(){
    if (state.rafId) cancelAnimationFrame(state.rafId);
    state.rafId = null;
  }

  // ====== è¤‡æ•°äººã‚¿ã‚¤ãƒãƒ¼ ======
  const multiTimers = []; // {id, el, total, remain, running}
  let multiTicker = null;

  function two(n){ return String(Math.floor(n)).padStart(2,'0'); }
  function fmtHMS(sec){
    sec = Math.max(0, sec);
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = Math.floor(sec%60);
    return `${two(h)}<span class="sep colon">:</span>${two(m)}<span class="sep colon">:</span>${two(s)}`;
  }
  // å…¥åŠ›æ–‡å­—åˆ— "HH:MM:SS" / "MM:SS" / "SS" ã‚’ç§’ã«å¤‰æ›ï¼ˆå…¨è§’ã‚³ãƒ­ãƒ³ãƒ»ç©ºç™½é™¤å»å¯¾å¿œï¼‰
  function parseHMS(str){
    if (!str) return null;
    str = String(str).trim()
      .replace(/[ï¼š]/g, ':')   // å…¨è§’ã‚³ãƒ­ãƒ³â†’åŠè§’
      .replace(/\s+/g, '');
    const parts = str.split(':').map(x=>x.replace(/[^\d]/g,''));
    if (parts.some(p => p==='' )) return null;
    let h=0,m=0,s=0;
    if (parts.length===3){ h=+parts[0]; m=+parts[1]; s=+parts[2]; }
    else if (parts.length===2){ m=+parts[0]; s=+parts[1]; }
    else if (parts.length===1){ s=+parts[0]; }
    else return null;
    if (isNaN(h)||isNaN(m)||isNaN(s)) return null;
    if (m>59||s>59) return null;
    return h*3600 + m*60 + s;
  }

  // --- ç«¯æœ«åˆ¤å®šï¼ˆiPadOSã®ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—UAã‚‚è€ƒæ…®ï¼‰ï¼‹ æ™‚é–“ç·¨é›†UIï¼ˆiPad=ãƒ€ã‚¤ãƒ¤ãƒ« / PC=å…¥åŠ›ãƒ‘ãƒãƒ«ï¼‰ ---
function isIOS(){
  const ua = navigator.userAgent || '';
  const platform = navigator.platform || '';
  const touch = navigator.maxTouchPoints || 0;
  return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && touch > 1);
}

function secToHMSval(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = String(Math.floor(sec/3600)).padStart(2,'0');
  const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

function timeValueToSec(v){
  if (!v) return null;
  const parts = v.split(':').map(x=>parseInt(x,10));
  if (parts.length === 3) return parts[0]*3600 + parts[1]*60 + (isNaN(parts[2])?0:parts[2]);
  if (parts.length === 2) return parts[0]*3600 + parts[1]*60;
  return null;
}

function openTimeEditor(t, anchorEl){
  // --- iPadï¼šéš ã— <input type="time" step="1"> ã®ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’å‘¼ã³å‡ºã™ ---
  if (isIOS()){
    const ip = document.getElementById('hiddenTimePicker');
    if (!ip){
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼špromptï¼ˆã¾ãšã¯å®‰å…¨ç­–ï¼‰
      const cur = secToHMSval(t.total);
      const nv  = prompt('æ™‚é–“ã‚’å…¥åŠ›ï¼ˆHH:MM ã¾ãŸã¯ HH:MM:SSï¼‰', cur);
      const p   = parseHMS(nv);
      if (p!=null){
        t.total = Math.max(1, p);
        if (!t.running) t.remain = t.total; else t.remain = Math.min(t.remain, t.total);
        updateCardUI(t);
      }
      return;
    }
    ip.value = secToHMSval(t.total);
    const handler = ()=>{
      const v = ip.value;
      const sec = timeValueToSec(v);
      if (sec!=null){
        t.total = Math.max(1, sec);
        if (!t.running) t.remain = t.total; else t.remain = Math.min(t.remain, t.total);
        updateCardUI(t);
      }
      ip.removeEventListener('change', handler);
    };
    ip.addEventListener('change', handler, {once:true});
    if (typeof ip.showPicker === 'function'){ ip.showPicker(); }
    else { ip.focus(); ip.click(); }
    return;
  }

  // --- PCï¼šå°ã•ãªå…¥åŠ›ãƒ‘ãƒãƒ«ï¼ˆH/M/Sï¼‰ ---
  const cur = Math.max(0, Math.floor(t.total));
  const ch = Math.floor(cur/3600), cm = Math.floor((cur%3600)/60), cs = cur%60;

  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9999;
    display:flex; align-items:center; justify-content:center;
  `;
  const panel = document.createElement('div');
  panel.style.cssText = `
    background:#121212; color:#fff; border:2px solid #2a2a2a; border-radius:12px;
    padding:16px; min-width:280px; font-family:inherit; box-shadow:0 10px 30px rgba(0,0,0,.5);
  `;
  panel.innerHTML = `
    <div style="font-weight:800; margin-bottom:8px;">æ™‚é–“ã‚’å…¥åŠ›</div>
    <div style="display:flex; gap:8px; align-items:center; justify-content:center; margin-bottom:12px;">
      <input id="ih" type="number" min="0" max="99" value="${ch}" style="width:4.2em; text-align:center; background:#111; color:#fff; border:2px solid #444; border-radius:8px; padding:.25em .4em;"> <span>æ™‚é–“</span>
      <input id="im" type="number" min="0" max="59" value="${cm}" style="width:4.2em; text-align:center; background:#111; color:#fff; border:2px solid #444; border-radius:8px; padding:.25em .4em;"> <span>åˆ†</span>
      <input id="is" type="number" min="0" max="59" value="${cs}" style="width:4.2em; text-align:center; background:#111; color:#fff; border:2px solid #444; border-radius:8px; padding:.25em .4em;"> <span>ç§’</span>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="cancelBtn" style="background:#333; color:#fff; border:1px solid #444; border-radius:8px; padding:.4em .8em; font-weight:700;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="okBtn" style="background:#7ee0ff; color:#000; border:2px solid #7ee0ff; border-radius:8px; padding:.4em .9em; font-weight:800;">OK</button>
    </div>
  `;
  overlay.appendChild(panel);
  document.body.appendChild(overlay);

  const ih = panel.querySelector('#ih'), im = panel.querySelector('#im'), is = panel.querySelector('#is');
  const ok = panel.querySelector('#okBtn'), cancel = panel.querySelector('#cancelBtn');

  function close(){ overlay.remove(); }
  function submit(){
    const H = Math.max(0, parseInt(ih.value||'0',10));
    const M = Math.max(0, Math.min(59, parseInt(im.value||'0',10)));
    const S = Math.max(0, Math.min(59, parseInt(is.value||'0',10)));
    const total = H*3600 + M*60 + S;
    if (total > 0){
      t.total = total;
      if (!t.running) t.remain = t.total; else t.remain = Math.min(t.remain, t.total);
      updateCardUI(t);
    }
    close();
  }
  ok.addEventListener('click', submit);
  cancel.addEventListener('click', close);
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
  panel.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') submit();
    if (e.key === 'Escape') close();
  });
}

  function startMultiTicker(){
    if (multiTicker) return;
    multiTicker = setInterval(()=>{
      const now = Date.now();
      multiTimers.forEach(t=>{
        if (!t.running) return;
        t.remain = Math.max(0, t.remain - 0.2);
        updateCardUI(t);
        if (t.remain <= 0){ t.running = false; }
      });
    }, 200);
  }
  function stopMultiTicker(){
    if (multiTicker){ clearInterval(multiTicker); multiTicker = null; }
  }

  function updateLayout(){
    if (!multiGrid) return;
    const n = multiTimers.length;
    multiGrid.dataset.count = String(n);
    multiGrid.classList.remove('layout-1','layout-2-3','layout-4','layout-5-6','layout-7-8','layout-9-12');
    if (n<=1) multiGrid.classList.add('layout-1');
    else if (n<=3) multiGrid.classList.add('layout-2-3');
    else if (n===4) multiGrid.classList.add('layout-4');
    else if (n<=6) multiGrid.classList.add('layout-5-6');
    else if (n<=8) multiGrid.classList.add('layout-7-8');
    else multiGrid.classList.add('layout-9-12');
  }

  function toggleAddFabVisibility(){
    if (!addTimerBtn) return;
    if (multiTimers.length >= 12) addTimerBtn.classList.add('hidden');
    else addTimerBtn.classList.remove('hidden');
  }

  function updateCardUI(t){
    if (!t.el) return;
    const titleEl = t.el.querySelector('.mc-title');
    const timeEl  = t.el.querySelector('.mc-time');
    const barFill = t.el.querySelector('.mc-bar-fill');
    const btn     = t.el.querySelector('.mc-toggle');
    if (titleEl) titleEl.textContent = t.title || 'ãƒ†ã‚¹ãƒˆå';
    timeEl.innerHTML = fmtHMS(Math.ceil(t.remain));
    const ratio = Math.max(0, Math.min(1, t.remain / t.total));
    barFill.style.width = (ratio*100).toFixed(2) + '%';
    btn.textContent = t.running ? 'â¸' : 'â–¶ï¸';
  }

  function createTimerCard(){
    if (!multiGrid) return;
    if (multiTimers.length >= 12){
      alert('ã‚¿ã‚¤ãƒãƒ¼ã¯æœ€å¤§12å€‹ã¾ã§ã§ã™');
      return;
    }
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 10åˆ†
    const t = {
      id: 'mt' + Date.now() + Math.random().toString(36).slice(2,6),
      title: 'ãƒ†ã‚¹ãƒˆå',
      total: 600, remain: 600, running: false, el: null
    };
    const card = document.createElement('div');
    card.className = 'multi-card';
    card.innerHTML = `
      <div class="mc-title">ãƒ†ã‚¹ãƒˆå</div>
      <div class="mc-time"><span>00</span><span class="sep colon">:</span><span>10</span><span class="sep colon">:</span><span>00</span></div>
      <div class="mc-bar"><div class="mc-bar-fill" style="width:100%"></div></div>
      <div class="mc-status">
        <button class="btn mc-toggle">â–¶ï¸</button>
        <button class="btn mc-delete">æ¶ˆå»</button>
      </div>
    `;
    multiGrid.appendChild(card);
    t.el = card;
    multiTimers.push(t);
    updateCardUI(t);
    updateLayout();
    startMultiTicker();
    toggleAddFabVisibility();

    // å†ç”Ÿ/ä¸€æ™‚åœæ­¢
    card.querySelector('.mc-toggle').addEventListener('click', ()=>{
      t.running = !t.running;
      updateCardUI(t);
    });

    // æ¶ˆå»
    card.querySelector('.mc-delete').addEventListener('click', (e)=>{
      e.stopPropagation();
      const idx = multiTimers.findIndex(x=> x.id === t.id);
      if (idx !== -1){
        multiTimers.splice(idx,1);
        card.remove();
        updateLayout();
        toggleAddFabVisibility();
      }
    });

    // è¿‘å‚ã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼šã‚¿ã‚¤ãƒˆãƒ«
    const titleEl = card.querySelector('.mc-title');
    titleEl.addEventListener('click', (e)=>{
      e.stopPropagation();
      const nv = prompt('ãƒ†ã‚¹ãƒˆåã‚’å…¥åŠ›', t.title || 'ãƒ†ã‚¹ãƒˆå');
      if (nv!=null){
        t.title = String(nv).trim() || 'ãƒ†ã‚¹ãƒˆå';
        updateCardUI(t);
      }
    });
    // è¿‘å‚ã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼šæ™‚é–“ï¼ˆiPad=ãƒ€ã‚¤ãƒ¤ãƒ« / PC=å…¥åŠ›ãƒ‘ãƒãƒ«ï¼‰
const timeEl = card.querySelector('.mc-time');
timeEl.addEventListener('click', (e)=>{
  e.stopPropagation();
  openTimeEditor(t, card);
});

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ã€Œæœ€å¤§åŒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå†…ã§å¼·èª¿ã€(è¦–è¦šçš„ã«)
    card.addEventListener('click', (e)=>{
      if (e.target.closest('.mc-toggle') || e.target.closest('.mc-delete')) return; // ãƒœã‚¿ãƒ³ã¯é™¤å¤–
      document.querySelectorAll('.multi-card').forEach(c=> c.style.outline='none');
      card.style.outline = '4px solid var(--accent)';
      setTimeout(()=>{ card.style.outline='none'; }, 700);
    });
  }

  if (addTimerBtn){
    addTimerBtn.addEventListener('click', createTimerCard);
  }
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  if (backToMenuBtn){
    backToMenuBtn.addEventListener('click', ()=> show(menu));
  }

  // â–¶ï¸/â¸ ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
  function togglePlay(){
    if (state.running) {
      pause();
    } else {
      start();
    }
  }
  if (btnToggle) btnToggle.addEventListener('click', togglePlay);

  // ------- ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ï¼ˆéŸ³å£°åˆæˆï¼‰ -------
  function speak(text){
    try{
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      // ç°¡æ˜“ãªç”·å¥³è¡¨ç¾ï¼ˆå£°è‰²ã¯ç«¯æœ«ä¾å­˜ï¼‰
      if (state.voice === 'male'){ u.pitch = 0.8; u.rate = 1.0; }
      else { u.pitch = 1.2; u.rate = 1.05; }
      window.speechSynthesis.cancel(); // å‰ã®ç™ºè©±ã‚’æ­¢ã‚ã‚‹ï¼ˆè¢«ã‚Šé˜²æ­¢ï¼‰
      window.speechSynthesis.speak(u);
    }catch{}
  }
  function speakPoint(p){
    if (p === -1){
      speak('è©¦é¨“ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
    }else if (p === 0){
      speak('è©¦é¨“çµ‚äº†ã§ã™ã€‚é‰›ç­†ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚');
      flashEnd();
    }else if (p === 60){
      speak('æ®‹ã‚Šä¸€åˆ†ã§ã™ã€‚');
    }else if (p === 180){
      speak('æ®‹ã‚Šä¸‰åˆ†ã§ã™ã€‚');
    }else if (p === 300){
      speak('æ®‹ã‚Šäº”åˆ†ã§ã™ã€‚');
    }
  }

  // çµ‚äº†æ™‚ã«èµ¤â†”é»’ã§ç‚¹æ»…
  function flashEnd(){
    let n=0;
    const el = document.body;
    const id = setInterval(()=>{
      n++;
      el.style.background = (n%2)?'#ff3b3b':'#000';
      if (n>=10){ clearInterval(id); el.style.background = 'var(--bg)'; }
    }, 160);
  }

  // ===== ã—ãã„å€¤ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼†ã‚¢ãƒ©ãƒ¼ãƒ ï¼ˆè¤‡æ•°ã‚¿ã‚¤ãƒãƒ¼ç”¨ï¼‰ =====
  // ã‚¿ã‚¤ãƒ«(=ã‚¿ã‚¤ãƒãƒ¼æ )ã®DOMã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å·®ç•°ã‚’å¸åï¼‰
  function getTileEl(tile){
    return tile.el || tile.elem || tile.node || tile.card || tile.root ||
           (tile.id ? document.querySelector(`[data-tile-id="${tile.id}"]`) : null);
  }

  // æ®‹ã‚Šæ™‚é–“ã«å¿œã˜ã¦æ ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°ï¼ˆ5åˆ†/3åˆ†/1åˆ†ï¼‰
  function updateTileWarnState(tile){
    const el = getTileEl(tile);
    if(!el) return;
    el.classList.remove('mt-warn5','mt-warn3','mt-warn1','mt-finished','mt-flash');
    const r = Math.ceil(tile.remainSec || 0);
    if(r <= 0){
      el.classList.add('mt-finished');
      return;
    }
    if(r <= 60)      el.classList.add('mt-warn1');
    else if(r <= 180)el.classList.add('mt-warn3');
    else if(r <= 300)el.classList.add('mt-warn5');
  }

  // ===== ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚è¨ˆç³»ã‚¢ãƒ©ãƒ¼ãƒ ãƒ»ã‚µã‚¦ãƒ³ãƒ‰ã‚­ãƒƒãƒˆ =====
let __audioCtx = null, __masterGain = null;
const ALARM_GAIN = 0.25; // å…¨ä½“ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆ0.0â€“1.0ï¼‰

function ensureAudio(){
  if (!__audioCtx) {
    __audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    __masterGain = __audioCtx.createGain();
    __masterGain.gain.value = ALARM_GAIN;
    __masterGain.connect(__audioCtx.destination);
  }
  // iOSå¯¾ç­–ï¼šä¸€æ™‚åœæ­¢çŠ¶æ…‹ãªã‚‰å†é–‹
  if (__audioCtx.state === 'suspended') {
    __audioCtx.resume().catch(()=>{});
  }
  return __audioCtx;
}

/** å˜éŸ³ãƒˆãƒ¼ãƒ³ï¼ˆADSRã¤ãï¼‰ */
function tone(freq=1000, startTime=0, dur=0.12, {
  type='sine', attack=0.005, decay=0.08, sustain=0.0008, release=0.03, gain=1.0, vibratoHz=0, vibratoDepth=0
} = {}){
  const ctx = ensureAudio();
  const t0 = (startTime ? startTime : ctx.currentTime);
  const t1 = t0 + dur;

  const osc = ctx.createOscillator();
  const g   = ctx.createGain();

  osc.type = type;
  osc.frequency.setValueAtTime(freq, t0);

  // ã»ã‚“ã®å°‘ã—ã®ã‚¢ã‚¿ãƒƒã‚¯â†’æ¸›è¡°â†’ã‚µã‚¹ãƒ†ã‚£ãƒ³â†’ãƒªãƒªãƒ¼ã‚¹
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.linearRampToValueAtTime(0.8*gain, t0 + attack);
  g.gain.exponentialRampToValueAtTime(Math.max(sustain, 0.0001), t0 + attack + decay);
  g.gain.setValueAtTime(Math.max(sustain, 0.0001), t1 - release);
  g.gain.exponentialRampToValueAtTime(0.0001, t1);

  // ä»»æ„ï¼šè»½ã„ãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆ
  if (vibratoHz > 0 && vibratoDepth > 0){
    const lfo = ctx.createOscillator();
    const lfoGain = ctx.createGain();
    lfo.frequency.value = vibratoHz;
    lfoGain.gain.value = vibratoDepth;
    lfo.connect(lfoGain).connect(osc.frequency);
    lfo.start(t0);
    lfo.stop(t1);
  }

  osc.connect(g).connect(__masterGain || ctx.destination);
  osc.start(t0);
  osc.stop(t1 + 0.01);
  return t1;
}

/** ãƒ—ãƒªã‚»ãƒƒãƒˆå†ç”Ÿ */
function playAlarm(name='watch'){
  const ctx = ensureAudio();
  let t = ctx.currentTime;

  switch(name){
    // ä¸€ç•ªâ€œè…•æ™‚è¨ˆâ€ã£ã½ã„ï¼šçŸ­ã„é«˜éŸ³ãƒ”ãƒƒÃ—2 ã‚’å°‘ã—é–“ã‚’ç©ºã‘ã¦2ã‚»ãƒƒãƒˆ
    case 'watch': {
      for(let k=0;k<2;k++){
        t = tone(2000, t, 0.09, {type:'triangle', attack:0.003, decay:0.05, sustain:0.0007, release:0.03}); t += 0.07;
        t = tone(2000, t, 0.09, {type:'triangle', attack:0.003, decay:0.05, sustain:0.0007, release:0.03}); t += 0.22;
      }
      break;
    }
    // CASIOé¢¨ï¼šé«˜â†’ä½ã®ãƒ„ãƒ¼ãƒˆãƒ³ï¼ˆçŸ­ã‚ï¼‰Ã—2
    case 'casio': {
      for(let k=0;k<2;k++){
        t = tone(1975, t, 0.08, {type:'sine'}); t += 0.06;
        t = tone(1310, t, 0.10, {type:'sine'}); t += 0.20;
      }
      break;
    }
    // SEIKOé¢¨ï¼šé«˜ã‚â€œãƒ”ãƒƒâ€ã‚’3é€£
    case 'seiko': {
      for(let i=0;i<3;i++){ t = tone(1900, t, 0.085, {type:'sine'}); t += 0.10; }
      break;
    }
    // ãƒãƒ£ã‚¤ãƒ ï¼šDING-DONG ã½ã 2éŸ³
    case 'chime': {
      t = tone(1318, t, 0.22, {type:'sine', attack:0.005, decay:0.18}); t += 0.05; // E6
      t = tone(987 , t, 0.28, {type:'sine', attack:0.005, decay:0.22});           // B5
      break;
    }
    // ãƒ–ã‚¶ãƒ¼ï¼šã‚„ã‚„è’ã‚ï¼ˆæ³¨æ„å–šèµ·ï¼‰
    case 'buzzer': {
      for(let i=0;i<2;i++){
        t = tone(420, t, 0.25, {type:'square', attack:0.005, decay:0.20, sustain:0.001, release:0.03, vibratoHz:20, vibratoDepth:8});
        t += 0.12;
      }
      break;
    }
    // å¾ã€…ã«é«˜ããªã‚‹3é€£
    case 'ascending': {
      [900, 1300, 1700].forEach(f=>{ t = tone(f, t, 0.10, {type:'triangle'}); t += 0.08; });
      break;
    }
    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼šä½Ã—3 â†’ é«˜ãƒ­ãƒ³ã‚°
    case 'countdown': {
      for(let i=0;i<3;i++){ t = tone(700, t, 0.11, {type:'sine'}); t += 0.10; }
      t = tone(1600, t, 0.35, {type:'triangle'});
      break;
    }
    default: {
      // å¾Œæ–¹äº’æ›ï¼ˆæ—§â€œãƒ”ãƒ”ãƒ”â€ï¼‰
      for(let i=0;i<2;i++){ t = tone(1200, t, 0.12, {type:'square'}); t += 0.18; }
    }
  }
}

  // çµ‚äº†æ™‚ã®å‡¦ç†ï¼šãƒ“ãƒ¼ãƒ—2å›ï¼‹èµ¤ç‚¹æ»…
  function handleTileFinish(tile){
    const el = getTileEl(tile);
    if(el){
      el.classList.remove('mt-warn5','mt-warn3','mt-warn1');
      el.classList.add('mt-finished','mt-flash');
    }
    beep(2, 1200, 120, 220); // ã€Œãƒ”ãƒ”ãƒ”ã€ã‚’2å›
  }

  // ===== è¤‡æ•°ã‚¿ã‚¤ãƒãƒ¼ã—ãã„å€¤ç›£è¦– =====
  setInterval(()=>{
    multiTimers.forEach(t=>{
      const el = t.el;
      if(!el) return;
      el.classList.remove('mt-warn5','mt-warn3','mt-warn1','mt-finished','mt-flash');
      const sec = Math.ceil(t.remain || 0);
      if(sec <= 0){
        el.classList.add('mt-finished','mt-flash');
        playAlarm('watch');
        t.running = false;
      }else if(sec <= 60){
        el.classList.add('mt-warn1');
      }else if(sec <= 180){
        el.classList.add('mt-warn3');
      }else if(sec <= 300){
        el.classList.add('mt-warn5');
      }
    });
  }, 500);

  // åˆå›èµ·å‹•ç”»é¢ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  show(menu);
})();
</script>
</body>
</html>